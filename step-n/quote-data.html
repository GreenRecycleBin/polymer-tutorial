<!doctype html>
<html>
<head>
  <link rel="import" href="../components/core-ajax/core-ajax.html">
  <link rel="import" href="../components/core-localstorage/core-localstorage.html">

</head>
<polymer-element name="quote-data" attributes="quotes">

<template>
  <style>
  :host {
    display: none;
  }
  </style>
  <core-ajax id="ajax" url="https://polymerdemo.firebaseio.com/quotes.json" auto on-core-response="{{quotesLoaded}}" 
       handleAs="json"></core-ajax>
  <core-localstorage id="localstorage" name="my-quote-favorites" value="{{favorites}}" on-core-localstorage-load="{{updateFavorites}}"></core-localstorage>

</template>
<script>
Polymer('quote-data', {
  created: function() {
    this.quotes = [ ];
    this.favorites = {};
  },
  quotesLoaded: function() {
    var loadedQuotes = this.$.ajax.response;
    for (var i=0, len=loadedQuotes.length; i<len; i++) {
      var q = loadedQuotes[i];
      q.uid = i;
      q.favorite = (q.uid in this.favorites);
      this.quotes.push(q);
    }
  },
  updateFavorites: function() {
    for (var i=0, len=this.quotes.length; i<len; i++) {
      this.quotes[i].favorite = (this.quotes[i].uid in this.favorites);
    }
  },
  setFavorite: function(uid) {
    this.favorites[uid] = true;
    this.$.localstorage.save();
    this.updateFavorites();
  }, 
  unsetFavorite: function(uid) {
    delete this.favorites[uid];
    this.quotes.favorites = false;
    this.$.localstorage.save();
    this.updateFavorites();
  }
});
</script>

</polymer-element>
</html>
